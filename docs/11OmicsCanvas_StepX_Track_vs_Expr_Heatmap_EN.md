# OmicsCanvas: Track vs Expression Heatmap (EN)

Script:
- `omicscanvas_histone_vs_expr_heatmap.py` (English help)
- `omicscanvas_histone_vs_expr_heatmap_CN.py` (Chinese help)

This step plots **ChIP-seq / ATAC-seq (or any binned track) matrices** as heatmaps after **binning genes by RNA expression**.
It is used to answer questions like:
- *How do different histone marks behave from TSS → gene body → TES as expression increases?*
- *Do highly expressed genes show stronger Pol II signal across the gene body?*

The script reads the **matrix files generated by Step2** (`omicscanvas_bam_to_gene_matrices.py`).

---

## 1) Required inputs

### 1.1 Matrix directory (Step2 output)
You pass a directory containing matrix files for each track/region.

**Recommended standardized suffixes (current OmicsCanvas convention):**
- `*_tss_matrix.tsv`
- `*_gene_profile_matrix.tsv`
- `*_tes_matrix.tsv`

Examples (prefix = `B_`):
- `B_H3K4me3_tss_matrix.tsv`
- `B_H3K4me3_gene_profile_matrix.tsv`
- `B_H3K4me3_tes_matrix.tsv`

If you still have old filenames, override with:
- `--suffix-tss`, `--suffix-gene`, `--suffix-tes`

### 1.2 Expression table (FPKM/TPM/count-derived)
Provide a TSV (recommended) where **row index is gene ID**.

Example (TSV):
```
GeneID	rep1	rep2	rep3
AT1G01010	5.2	4.9	5.1
AT1G01020	0	0	0
...
```

You select which columns are used to compute the mean expression with `--expr-cols`.

---

## 2) Track definition syntax (`--tracks`)

`--tracks` is **comma-separated**. Each item supports:

1) `NAME`
- Display name = `NAME`
- File ID = `<file-prefix>NAME`

2) `NAME:FILEID`
- Display name = `NAME`
- File ID = `<file-prefix>FILEID`

3) Replicates: `NAME:REP1+REP2+REP3`
- Each `REP*` becomes `<file-prefix>REP*`
- Replicates are averaged element-wise before plotting

Examples:

```bash
--tracks "ATAC,H3K4me1,H3K4me3" --file-prefix "B_"
```

```bash
--tracks "ATAC:ATAC_rep1+ATAC_rep2,H3K4me3" --file-prefix "B_"
```

---

## 3) Gene regions (`--gene-types`) and axis templates

`--gene-types` controls which region(s) are plotted:
- `TSS`  : around transcription start site
- `gene` : upstream + scaled gene body + downstream (full gene profile)
- `TES`  : around transcription end site

Example:
```bash
--gene-types TSS,gene,TES
```

The x-axis ticks/labels and vertical guide lines are derived from:
- `--distance`
- `--bins-start`, `--bins-end`
- `--bins-gene-st`, `--bins-gene-body`, `--bins-gene-en`

**Important:** these `--bins-*` must match the actual matrix column count.

---

## 4) Gene ID matching (expression ↔ matrices)

Different pipelines may use transcript IDs (e.g., `AT1G01010.1`) or gene IDs (`AT1G01010`).

Use:
- `--gene-id-mode exact`
  - IDs must match exactly
- `--gene-id-mode strip_dot`
  - `AT1G01010.1` → `AT1G01010`

If `strip_dot` leads to multiple isoforms per gene, `--collapse-isoform` controls how to merge:
- `mean` (default)
- `max`
- `first`

Optional filter:
- `--isoform-suffix .1`
  - only keep rows ending with `.1`

---

## 5) Expression binning

Genes are split into two parts:
- expression `<= --zero-threshold` → `--none-bins` groups
- expression `>  --zero-threshold` → `--exp-bins` groups

Each group produces **one heatmap row**.

Within each group, you choose the statistic across genes:
- `--stat mean` (default)
- `--stat median`

Sorting direction:
- default: low → high
- `--descending`: high → low

---

## 6) Color scale (vmin/vmax) and colormap

You can set color scaling in two ways:

### 6.1 Automatic scaling (recommended)
`--scale-mode`:
- `quantile` (default): use `--quantiles` (e.g., `0.01,0.99`)
- `diverging`: symmetric around 0, suitable for Z-score matrices
- `ratio`: 0..max, suitable for non-negative signal

Optional shortcut:
- `--range X`
  - diverging → `[-X, +X]`
  - others    → `[0, X]`

### 6.2 Manual scaling
- `--vmin` and `--vmax` override all automatic inference

Colormap:
- `--cmap RdBu_r` (diverging)
- `--cmap viridis` (sequential)

If `--cmap` is not set, the script chooses a reasonable default based on `--scale-mode`.

---

## 7) Outputs

For each (track × gene-type) combination, the script writes:

`<outdir>/<out-prefix>_<track>_<gene-type>_histone_vs_expr_heatmap.<ext>`

Where:
- `<ext>` is `pdf` or `png` controlled by `--out-format`

Plot controls:
- `--dpi` (PNG and PDF rasterization)
- `--ytick-step` (row tick spacing)
- `--no-border` (hide outer border)
- `--title` (optional title)

---

## 8) Example commands

### Example A: Standard naming, plot all regions
```bash
python omicscanvas_histone_vs_expr_heatmap.py \
  --matrix-dir caculate_matrix \
  --tracks "ATAC,H3K4me1,H3K4me3" \
  --file-prefix "B_" \
  --gene-types TSS,gene,TES \
  --expr FPKM_all.txt \
  --expr-cols 0,1,2 \
  --none-bins 10 \
  --exp-bins 90 \
  --distance 2000 \
  --bins-start 100 --bins-end 100 \
  --bins-gene-st 50 --bins-gene-body 100 --bins-gene-en 50 \
  --cmap RdBu_r \
  --scale-mode quantile --quantiles 0.01,0.99 \
  --out-format png \
  --outdir out_heatmap \
  --out-prefix B
```

### Example B: Old filenames (override suffix)
```bash
python omicscanvas_histone_vs_expr_heatmap.py \
  --matrix-dir caculate_matrix \
  --tracks "H3K4me3" --file-prefix "B_" \
  --gene-types gene \
  --suffix-gene _gene_body_matrix.txt \
  --expr FPKM_all.txt \
  --out-prefix legacy
```

---

## 9) Common pitfalls

1) **No overlap genes**
- Your matrix gene IDs and expression gene IDs differ (use `--gene-id-mode strip_dot` or adjust IDs).

2) **Bins mismatch**
- Your `--bins-*` settings do not match the matrix column count.

3) **Heatmap looks flat**
- Set a better scale: try `--scale-mode quantile --quantiles 0.05,0.95` or manually set `--vmin/--vmax`.

