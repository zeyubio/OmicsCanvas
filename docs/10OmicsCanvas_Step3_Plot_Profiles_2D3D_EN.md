# OmicsCanvas Step 3: Plot Whole Profiles (2D / 3D)

This step visualizes **meta‑profiles** (1D tracks) from the matrix files generated by the OmicsCanvas matrix generator (recommended) or the legacy generator.

- Script: `omicscanvas_plot_whole_profile_2d3d.py` (English)
- Chinese script: `omicscanvas_plot_whole_profile_2d3d_CN.py`

---

## 1. What this script does

Given one or more **matrix files** per sample (e.g., ChIP‑seq coverage, ATAC‑seq coverage, RNA coverage, methylation, etc.), the script:

1. Loads matrices by **sample prefix** and **region type** (TSS / gene / TES).
2. Applies optional gene ID filtering (default keeps only `.1` transcript IDs).
3. Computes a 1D profile per sample (mean/median across genes).
4. Plots profiles as either:
   - **2D**: one axis per panel; panels arranged in a grid (columns × panels).
   - **3D**: “stacked” axes (offset) inside each column with vertical connectors.

---

## 2. Input matrix naming (standard vs legacy)

This script supports two filename conventions controlled by `--naming`.

### Standard naming (recommended)
Default when `--naming standard`:

- **TSS** window: `*_tss_matrix.tsv`
- **gene profile**: `*_gene_profile_matrix.tsv`
- **TES** window: `*_tes_matrix.tsv`

### Legacy naming
When `--naming legacy`:

- **TSS** window: `*_start_matrix.txt`
- **gene profile**: `*_gene_body_matrix.txt`
- **TES** window: `*_end_matrix.txt`

You normally **do not** need to override suffixes manually. If you must, advanced options exist:

- `--suffix-tss` / `--suffix-start`
- `--suffix-gene`
- `--suffix-tes` / `--suffix-end`

---

## 3. The key arguments

### Required

- `--mode {2d,3d}`
  - `2d`: one axes per panel.
  - `3d`: stacked axes + vertical connectors (better for “floating layers”).

- `--matrix-dir DIR`
  Folder containing the matrix files.

- `--group STRING`
  **Panel layout + sample prefixes**. Separators:

  - `,` = multiple samples in the same panel (multiple lines)
  - `;` = multiple panels stacked in the same column
  - `|` = new column

  Each token is a **sample prefix** used to load: `<matrix-dir>/<prefix><suffix>`.

- `--names STRING`
  Legend names for each sample line. Must match the exact structure of `--group`.

- `--ylabels STRING`
  One y‑axis label per panel. Uses `;` and optional `|` (no comma split).

- `--out FILE`
  Output figure path (`.pdf`, `.png`, `.svg`, ...).

### Common scientific parameters

- `--gene-type {TSS,gene,TES}`
  Select which region to plot.

- `--distance INT`
  Flank size (bp) used only for axis labels (e.g., “±2000 bp”).

- `--bins-start INT`, `--bins-end INT`
  Total bins for TSS and TES windows.

- `--bins-gene-st INT`, `--bins-gene-body INT`, `--bins-gene-en INT`
  Bins for the three parts in the gene profile.

- `--stat {mean,median}`
  Statistic used to collapse genes → one profile.

- `--scale FLOAT`
  Multiply matrix values by this factor before profiling (useful when matrices store small decimals).

- `--index-filter REGEX`
  Filter which gene/transcript IDs to include (default keeps `.1`). Use `''` to disable.

### Appearance

- `--fig-x FLOAT`, `--fig-y FLOAT`
- `--line-lw FLOAT`
- `--cmap STR` (matplotlib colormap)
- `--line-colors "c1,c2,..."` (optional explicit colors)
- `--ylim "ymin,ymax;ymin,ymax;..."` per panel (optional)
- `--legend / --no-legend`, `--legend-loc {inside,outside}`, `--legend-anchor "x,y"`
- `--share-y {none,column,all}`

### Layout controls

These are useful when you want publication‑grade geometry.

- `--base-left`, `--base-top`
- `--col-width`, `--panel-height`
- `--col-gap`, `--panel-gap`
- `--x-off`, `--y-off` (3D stacking offsets)
- `--strict-layout` (raise if the grid would overflow)

---

## 4. JSON config to reduce repetitive arguments

You can put common arguments into a JSON file and load it with `--config`.

- Keys may use `-` or `_`.
- CLI options always override config values.

Example:

```bash
python omicscanvas_plot_whole_profile_2d3d.py \
  --config plot_profile_config.json \
  --mode 3d \
  --gene-type gene \
  --group "G_H3K4me3,B_H3K4me3,R_H3K4me3;G_H3K27me3,B_H3K27me3,R_H3K27me3" \
  --names "G,B,R;G,B,R" \
  --ylabels "H3K4me3;H3K27me3" \
  --out whole_profile_gene_3d.pdf
```

---

## 5. Worked examples

### Example A: 2D, one column, multiple panels

```bash
python omicscanvas_plot_whole_profile_2d3d.py \
  --mode 2d \
  --matrix-dir caculate_matrix \
  --gene-type gene \
  --group "G_Input,B_Input,R_Input;G_H3K4me3,B_H3K4me3,R_H3K4me3" \
  --names "G,B,R;G,B,R" \
  --ylabels "Input;H3K4me3" \
  --out whole_profile_gene_2d.png
```

### Example B: 3D, multiple columns

```bash
python omicscanvas_plot_whole_profile_2d3d.py \
  --mode 3d \
  --matrix-dir caculate_matrix \
  --gene-type TES \
  --group "G_H3K4me3,B_H3K4me3,R_H3K4me3|G_H3K27me3,B_H3K27me3,R_H3K27me3" \
  --names "G,B,R|G,B,R" \
  --ylabels "H3K4me3|H3K27me3" \
  --out whole_profile_tes_3d.pdf
```

### Example C: legacy matrices

```bash
python omicscanvas_plot_whole_profile_2d3d.py \
  --mode 2d \
  --naming legacy \
  --matrix-dir caculate_matrix \
  --gene-type gene \
  --group "LSH10_H3K4me3,WT_H3K4me3" \
  --names "LSH10,WT" \
  --ylabels "H3K4me3" \
  --out legacy_profile_gene.png
```

---

## 6. Troubleshooting

- **File not found**: check `--matrix-dir`, `--naming`, and your prefixes in `--group`.
- **Structure mismatch**: `--names` must mirror `--group` exactly.
- **Empty plots**: common reasons are `--index-filter` removing all genes, or matrices containing only NaNs.
- **Layout overflow**: adjust `--col-width`, `--panel-height`, `--col-gap`, `--panel-gap`, or disable `--strict-layout`.

