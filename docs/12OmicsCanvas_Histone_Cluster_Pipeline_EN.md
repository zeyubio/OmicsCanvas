# OmicsCanvas – Cluster histone/track signals and link to expression (from Step2 matrices)

This script clusters genes using **ChIP-seq/ATAC-seq (or any track) gene-matrix outputs** from **OmicsCanvas Step2** (`omicscanvas_bam_to_gene_matrices.py`), then generates:

1. **Clustered heatmaps** (panel heatmaps + per-track heatmaps)
2. **Mean profile lines** for each cluster (per mark / per treatment)
3. **Expression distribution plots** (FPKM/TPM/CPM etc. in a TSV) per cluster

The workflow is designed for large matrices (many marks / treatments), so **panel heatmaps are saved as PNG** (PDF can be huge).

---

## Input files

### 1) Step2 matrix files
Generated by `omicscanvas_bam_to_gene_matrices.py`.

Each matrix is a TSV:
- **Index**: gene (or transcript) IDs
- **Columns**: bins, typically `bin_1 ... bin_N` (N depends on your bin settings)

**Standard naming (recommended / default):**
- TSS region: `<prefix>_tss_matrix.tsv`
- Gene profile region: `<prefix>_gene_profile_matrix.tsv`
- TES region: `<prefix>_tes_matrix.tsv`

These suffixes match your updated naming standard.

**Legacy naming (optional):**
- `<prefix>_start_matrix.txt`
- `<prefix>_gene_body_matrix.txt`
- `<prefix>_end_matrix.txt`

You can switch with `--naming legacy` or override suffixes with `--suffix-*`.

### 2) Expression table
A TSV where:
- **Column 1 (index_col=0)**: gene IDs
- Remaining columns: numeric expression columns (replicates)

You will map treatments to replicate columns using `--expr-cols`.

---

## How the grouping strings work

You control marks and treatments with **three aligned strings**:

### `--in-group` (prefix matrix groups)
- Split marks by `;`
- Within each mark, split treatments by `,`

Example with 2 marks and 3 treatments (G/B/R):

```
G_H3K4me3,B_H3K4me3,R_H3K4me3;G_H3K27me3,B_H3K27me3,R_H3K27me3
```

### `--in-ylabels` (mark labels)
Comma-separated mark names, one per `;` block in `--in-group`:

```
H3K4me3,H3K27me3
```

### `--in-names` (treatment labels)
- Split marks by `;`
- Within each mark, split treatments by `,`

Example:

```
G,B,R;G,B,R
```

---

## What the script does

### A) Load matrices
For each prefix in `--in-group`, the script loads:

`<matrix-dir>/<prefix><suffix>`

for regions selected in `--plot-regions` and for the region used in clustering (`--cluster-region`).

### B) ID normalization (matrix IDs ↔ expression IDs)
Step2 matrices sometimes use transcript IDs (e.g., `GeneX.1`) while expression uses gene IDs (`GeneX`).

Use `--id-mode`:
- `auto` (default): tries `none` → `drop_isoform` → `tx_to_gene`
- `drop_isoform`: remove isoform suffix like `.1`
- `tx_to_gene`: a common rule: `AT1G01010.1` → `AT1G01010`
- `regex`: custom mapping using `--id-regex` / `--id-repl`

If normalization creates duplicate rows, collapse with `--collapse-duplicates`.

### C) Build clustering feature matrix
Using only the region defined by `--cluster-region`:

1. For each track (mark × treatment), compute **zscore per gene across bins** (axis=1)
2. Concatenate all tracks into one large matrix (genes × features)
3. KMeans cluster (`--k`)

### D) Plot outputs
1) Panel heatmaps (2 PNGs each region: annotated + clean)
2) Per-track heatmaps (optional) + cluster boundaries
3) Mean profiles (per cluster) (PDF)
4) Expression boxplot per cluster (PDF)

---

## Typical command

```bash
python omicscanvas_histone_cluster_pipeline.py \
  --matrix-dir caculate_matrix \
  --in-group "G_H3K4me3,B_H3K4me3,R_H3K4me3;G_H3K27me3,B_H3K27me3,R_H3K27me3" \
  --in-ylabels "H3K4me3,H3K27me3" \
  --in-names "G,B,R;G,B,R" \
  --fpkm FPKM_all.txt \
  --expr-cols "G=0,1,2;B=3,4,5;R=6,7,8" \
  --cluster-region gene \
  --plot-regions TSS,gene,TES \
  --k 8 \
  --cmap RdBu_r \
  --zlim -2,2 \
  --out-prefix G_B_R_histone \
  --outdir histone_cluster_out
```

Notes:
- `--cluster-region gene` means clustering is computed from the **gene profile** region.
- `--plot-regions` controls which regions get heatmaps/profiles.

---

## Parameters (detailed)

### Input / naming
- `--matrix-dir` : folder containing Step2 matrices.
- `--naming` : `standard` (default) uses `_tss_matrix.tsv`, `_gene_profile_matrix.tsv`, `_tes_matrix.tsv`; `legacy` uses the old `*_start_matrix.txt` etc.
- `--suffix-tss`, `--suffix-gene`, `--suffix-tes` : override region suffixes (advanced).

### Grouping
- `--in-group` : prefixes grouped by mark and treatment.
- `--in-ylabels` : mark labels (comma-separated; align to blocks).
- `--in-names` : treatment labels per mark block.
- `--include-marks` / `--exclude-marks` : filter mark indices (0-based in the `;` order).

### Regions and bins
- `--cluster-region` : `TSS` / `gene` / `TES`.
- `--plot-regions` : comma-separated list of regions to plot.
- `--distance`, `--bins-start`, `--bins-gene-st`, `--bins-gene-body`, `--bins-gene-en`, `--bins-end` : only used to set tick marks / boundaries consistently with Step2.

### Normalization and clustering
- `--scale-factor` : multiply matrices by a constant after loading (kept for compatibility; default 10).
- `--zscore-axis` : typically 1 (per gene across bins).
- `--k` : number of clusters.
- `--random-state` : for reproducibility.

### Heatmap rendering
- `--cmap` : colormap (e.g., `RdBu_r`).
- `--zlim` : zscore range for heatmaps (`vmin,vmax`), e.g., `-2,2`.
- `--panel-cols`, `--panel-fig-x`, `--panel-fig-y`, `--panel-dpi` : panel heatmap layout.
- `--save-single` / `--no-single` : enable/disable per-track heatmaps.
- `--single-fig-x`, `--single-fig-y` : per-track heatmap size.

### Expression linking
- `--fpkm` : expression TSV.
- `--expr-cols` : map treatment name to replicate columns (0-based), e.g. `G=0,1,2;B=3,4,5;R=6,7,8`.
- `--expr-ylim` : y-limit for expression plot, e.g. `0,120`.

### ID alignment
- `--id-mode` : `auto|none|drop_isoform|tx_to_gene|regex`.
- `--id-regex`, `--id-repl` : only for `regex`.
- `--collapse-duplicates` : `mean|sum|first`.

### Output
- `--out-prefix` : prefix for output filenames.
- `--outdir` : output directory.

---

## Outputs
Inside `--outdir`:

- `figures/` : all plots
  - `*_panel_heatmaps_annot.png` : annotated panel heatmap
  - `*_panel_heatmaps_clean.png` : clean panel heatmap
  - `single_heatmaps/<region>/...png` : per-track heatmaps (if enabled)
  - `*_cluster_profiles.pdf` : per-cluster mean profiles
  - `*_cluster_expr_boxplot.pdf` : expression distribution per cluster

- `*_cluster_labels.tsv` : gene → cluster label
- `*_feature_matrix.tsv` : concatenated zscore feature matrix used for clustering

---

## Troubleshooting

- **No genes after merge**: ID mismatch. Try `--id-mode drop_isoform` or `--id-mode regex`.
- **Heatmaps look blank**: check `--zlim`, or confirm matrices are not all zeros.
- **Panel PNG too big**: reduce `--panel-fig-x/--panel-fig-y` or increase `--panel-cols`.

